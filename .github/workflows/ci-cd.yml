name: Smart Contract CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: celo-dapp/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd celo-dapp
        npm ci
    
    - name: Compile Contracts
      run: |
        cd celo-dapp
        npm run compile
    
    - name: Run Tests
      run: |
        cd celo-dapp
        npm test
    
    - name: Generate Coverage Report
      run: |
        cd celo-dapp
        npm run test -- --coverage || true
    
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./celo-dapp/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: celo-dapp/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd celo-dapp
        npm ci
    
    - name: Run Solidity Linter
      run: |
        cd celo-dapp
        npx solhint 'contracts/**/*.sol' || true
    
    - name: Check Contract Size
      run: |
        cd celo-dapp
        npm run compile
        npx hardhat size-contracts || true

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: celo-dapp/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd celo-dapp
        npm ci
    
    - name: Run Slither Security Analysis
      uses: crytic/slither-action@v0.3.0
      continue-on-error: true
      with:
        target: 'celo-dapp/contracts/'
        slither-args: '--filter-paths "@openzeppelin"'
    
    - name: Run npm audit
      run: |
        cd celo-dapp
        npm audit --production || true
    
    - name: Check for vulnerable dependencies
      run: |
        cd celo-dapp
        npm audit fix --dry-run || true

  deploy-testnet:
    name: Deploy to Alfajores (if tests pass)
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: celo-dapp/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd celo-dapp
        npm ci
    
    - name: Deploy to Alfajores
      env:
        CELO_RPC: ${{ secrets.CELO_RPC }}
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        CELOSCAN_API_KEY: ${{ secrets.CELOSCAN_API_KEY }}
      run: |
        cd celo-dapp
        npm run deploy:alfajores || echo "Deployment skipped - configure secrets"
    
    - name: Verify Contracts
      env:
        CELOSCAN_API_KEY: ${{ secrets.CELOSCAN_API_KEY }}
      run: |
        cd celo-dapp
        npm run verify:alfajores || echo "Verification skipped"

  gas-report:
    name: Gas Usage Report
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: celo-dapp/package-lock.json
    
    - name: Install Dependencies
      run: |
        cd celo-dapp
        npm ci
    
    - name: Generate Gas Report
      run: |
        cd celo-dapp
        REPORT_GAS=true npm test || true
    
    - name: Comment Gas Report on PR
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const gasReport = '## â›½ Gas Report\n\nGas usage analysis completed. Check workflow logs for details.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: gasReport
          });

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: always()
    
    steps:
    - name: Check Status
      run: |
        echo "Test Status: ${{ needs.test.result }}"
        echo "Lint Status: ${{ needs.lint.result }}"
        echo "Security Status: ${{ needs.security.result }}"
