<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Celo SimplePayments</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- App modules -->
  <script src="wallet-connector.js"></script>
  <script src="toast-notifications.js"></script>
  <script src="transaction-history.js"></script>
  <script src="gas-estimator.js"></script>
  <script src="token-manager.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 50%, #000000 100%);
        min-height: 100vh;
        color: #333;
      }
      .network-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 8px 14px;
        border-radius: 30px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 6px;
        letter-spacing: .5px;
        transition: background .3s, color .3s;
      }
      .network-ok { background: #35CD8C; color:#000; }
      .network-bad { background: #ff5252; color:#fff; }
      .network-indicator button {
        background: rgba(255,255,255,0.25);
        color: inherit;
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 20px;
        width: auto;
        box-shadow:none;
      }
      .network-indicator button:hover { background: rgba(255,255,255,0.4); transform:none; }
      .container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin: 20px 0;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
        border-bottom: 3px solid #35CD8C;
        padding-bottom: 20px;
      }
      h1 {
        color: #000000;
        margin-bottom: 5px;
        font-size: 2.5em;
        font-weight: 700;
      }
      .subtitle {
        color: #35CD8C;
        font-size: 1.1em;
        font-weight: 500;
      }
      .badge {
        display: inline-block;
        background: #FCFF52;
        color: #000;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 10px;
      }
      .section {
        margin: 25px 0;
        padding: 25px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        border-left: 5px solid #35CD8C;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }
      .section h3 {
        margin-top: 0;
        color: #000000;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .section h3::before {
        content: '';
        width: 8px;
        height: 8px;
        background: #35CD8C;
        border-radius: 50%;
      }
      input, textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.3s;
      }
      input:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      button {
        background: linear-gradient(135deg, #35CD8C 0%, #FCFF52 100%);
        color: #000000;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 700;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(53, 205, 140, 0.3);
      }
      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(53, 205, 140, 0.5);
        background: linear-gradient(135deg, #FCFF52 0%, #35CD8C 100%);
      }
      button:active {
        transform: translateY(-1px);
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #2196f3;
      }
      .success {
        background: #e8f5e9;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #4caf50;
      }
      .error {
        background: #ffebee;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border-left: 4px solid #f44336;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 2px solid #35CD8C;
        transition: transform 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(53, 205, 140, 0.2);
      }
      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #35CD8C;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      }
      .stat-label {
        font-size: 13px;
        color: #666;
        margin-top: 8px;
        font-weight: 500;
      }
      #status {
        min-height: 20px;
        margin: 15px 0;
      }
      .payment-history {
        max-height: 300px;
        overflow-y: auto;
      }
      .payment-item {
        background: white;
        padding: 12px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
      }
      .payment-item .address {
        font-family: monospace;
        font-size: 12px;
        color: #666;
      }
      .payment-item .amount {
        font-weight: bold;
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div id="networkIndicator" class="network-indicator network-bad" style="display:none;">
      <span id="networkStatusText">Network: Unknown</span>
      <button id="networkSwitchInline" onclick="switchToCelo()" style="display:none;">Switch</button>
    </div>
    <div class="container">
      <div class="header">
        <h1>ï¿½ Celo Payments</h1>
        <p class="subtitle">Decentralized Payment DApp</p>
        <span class="badge">Celo Mainnet â€¢ Chain ID: 42220</span>
      </div>

      <div class="section">
        <h3>ðŸ”— Connect Wallet</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
          <button id="connectMetaMask" onclick="connect('metamask')">ðŸ¦Š MetaMask</button>
          <button id="connectCoinbase" onclick="connect('coinbase')">ðŸ’Ž Coinbase</button>
          <button id="connectWC" onclick="connect('walletconnect')">ðŸ“± WalletConnect</button>
        </div>
        <div class="info" id="connectionBar" style="display:none; align-items:center; gap:10px;">
          <div><strong>Status:</strong> <span id="connStatus">Disconnected</span></div>
          <div><strong>Network:</strong> <span id="connNetwork">-</span></div>
          <div>
            <strong>Account:</strong> 
            <span id="walletAddress"></span>
            <button style="margin-left:6px; padding:6px 10px;" onclick="copyAddress()">ðŸ“‹ Copy</button>
          </div>
          <div><strong>Balance:</strong> <span id="walletBalance">0</span> <span id="balanceSymbol">CELO</span></div>
          <button id="switchNetworkBtn" style="background:#ff9800" onclick="switchToCelo()">Switch to Celo Mainnet</button>
        </div>
      </div>

      <div class="section">
        <h3>ðŸ“Š Contract Info</h3>
        <div class="info">
          <strong>Select Contract:</strong>
          <select id="contractSelect" onchange="switchContract()" style="width: 100%; padding: 8px; margin: 8px 0; border-radius: 6px; border: 2px solid #667eea;">
            <option value="primary">CA 1: 0x0B33...1402</option>
            <option value="secondary">CA 2: 0xb690...FB65</option>
            <option value="tertiary">CA 3: 0x5d0F...c75D</option>
          </select>
          <strong>Full Address:</strong><br>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <span id="contractAddr" style="font-family: monospace; word-break: break-all;">Loading...</span>
            <button type="button" id="copyContractBtn" style="width:auto; padding:6px 12px;" onclick="copyContractAddress()">ðŸ“‹ Copy</button>
          </div>
        </div>
        <div id="gasPanel" class="info" style="display:none; margin-top:10px;"></div>
        <button onclick="loadStats()">Refresh Stats</button>
        <div class="stats" id="statsContainer" style="display:none;">
          <div class="stat-card">
            <div class="stat-value" id="statBalance">0</div>
            <div class="stat-label">Contract Balance (CELO)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statReceived">0</div>
            <div class="stat-label">Total Received</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWithdrawn">0</div>
            <div class="stat-label">Total Withdrawn</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPayments">0</div>
            <div class="stat-label">Payment Count</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>ðŸ’° Send Payment</h3>
        <label>
          Token:
          <select id="tokenSelect"></select>
        </label>
        <label>
          Amount (CELO):
          <input type="number" id="paymentAmount" placeholder="0.001" step="0.001" value="0.001">
        </label>
        <label>
          Memo (optional):
          <textarea id="paymentMemo" placeholder="Payment note..." rows="2"></textarea>
        </label>
        <button onclick="sendPayment()">Send Payment</button>
        <div id="txPreview" class="info" style="display:none; margin-top:10px;"></div>
      </div>

      <div class="section">
        <h3>ðŸ§¾ Recent Transactions</h3>
        <div id="txHistory" class="info" style="max-height:240px; overflow:auto;">
          <em>No transactions yet.</em>
        </div>
        <div style="display:flex; gap:10px; margin-top:8px;">
          <button onclick="exportHistory()">Export CSV</button>
          <button onclick="clearHistory()">Clear History</button>
        </div>
      </div>

      <div class="section" style="display:none;" id="ownerSection">
        <h3>ðŸ‘‘ Owner Actions</h3>
        <label>
          Withdraw To:
          <input type="text" id="withdrawTo" placeholder="0x...">
        </label>
        <label>
          Amount (CELO):
          <input type="number" id="withdrawAmount" placeholder="0.001" step="0.001">
        </label>
        <button onclick="withdrawFunds()">Withdraw Funds</button>
        <button onclick="withdrawAll()">Withdraw All</button>
        <button onclick="pauseContract()">Pause Contract</button>
        <button onclick="unpauseContract()">Unpause Contract</button>
      </div>

      <div id="status"></div>
    </div>

    <script>
      // Multiple deployed contracts - Choose which one to use
      const CONTRACTS = {
        primary: '0x0B33158062bEBDFc1E6Fe2fA43a6cec943331402',   // CA 1
        secondary: '0xb690E08975b20e61904E7fae6127234F4Fe6FB65', // CA 2
        tertiary: '0x5d0F9219728cc9110577122875966254aaA9c75D'   // CA 3
      };
      
  // Using primary contract
      let CONTRACT_ADDR = CONTRACTS.primary;
      
  let provider, signer, contract, userAddress;
  const REQUIRED_CHAIN_ID = 42220; // Celo Mainnet
      
      const CONTRACT_ABI = [
        "function payWithMemo(string memory memo) external payable",
        "function withdraw(address payable to, uint256 amount) external",
        "function withdrawAll() external",
        "function pause() external",
        "function unpause() external",
        "function balance() external view returns (uint256)",
        "function getStats() external view returns (uint256, uint256, uint256, uint256, bool)",
        "function owner() external view returns (address)",
        "function paused() external view returns (bool)",
        "event Paid(address indexed payer, uint256 amount, string memo)"
      ];

      // Initialize
      document.getElementById('contractAddr').textContent = CONTRACT_ADDR;

      // Populate token selector
      function populateTokens() {
        const sel = document.getElementById('tokenSelect');
        sel.innerHTML = '';
        const tokens = tokenManager.getAllTokens();
        tokens.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.symbol;
          opt.textContent = `${t.icon} ${t.symbol} - ${t.name}`;
          sel.appendChild(opt);
        });
        sel.value = tokenManager.selectedToken;
        sel.onchange = async () => {
          tokenManager.selectToken(sel.value);
          document.getElementById('balanceSymbol').textContent = sel.value;
          await refreshBalance();
        };
      }

      function switchContract() {
        const selected = document.getElementById('contractSelect').value;
        CONTRACT_ADDR = CONTRACTS[selected];
        document.getElementById('contractAddr').textContent = CONTRACT_ADDR;
        
        // Reinitialize contract if already connected
        if (contract && signer) {
          contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);
          loadStats();
        }
        
        showStatus('Switched to ' + selected + ' contract', 'info');
      }

      async function connect(walletId = 'metamask') {
        try {
          const { provider: p, signer: s, address, chainId } = await walletConnector.connect(walletId);
          provider = p; signer = s; userAddress = address;
          txHistory.init(provider);
          gasEstimator.init(provider);
          contract = new ethers.Contract(CONTRACT_ADDR, CONTRACT_ABI, signer);

          // Check network and prompt switch if wrong
          if (chainId !== REQUIRED_CHAIN_ID) {
            document.getElementById('switchNetworkBtn').style.display = 'inline-block';
            toast.wrongNetwork('Celo Mainnet');
          } else {
            document.getElementById('switchNetworkBtn').style.display = 'none';
          }

          updateNetworkIndicator(chainId);
          setupChainListeners();

          // Get balance
          await refreshBalance();

          // Update UI
          updateConnectionBar();
          document.getElementById('connectionBar').style.display = 'flex';
          toast.walletConnected(userAddress);
          populateTokens();

          // Check if user is owner
          try {
            const owner = await contract.owner();
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
              document.getElementById('ownerSection').style.display = 'block';
            }
          } catch (e) {
            console.log('Could not check owner:', e);
          }

          // Load stats
          await loadStats();
          await renderTxHistory();

        } catch (error) {
          console.error('Connection error:', error);
          showStatus('Failed to connect wallet: ' + error.message, 'error');
          toast.error('Connection Failed', error.message);
        }
      }

      async function refreshBalance() {
        if (!provider || !userAddress) return;
        tokenManager.init(provider, signer, userAddress);
        const symbol = tokenManager.getSelectedToken().symbol;
        const bal = await tokenManager.getBalance(symbol, userAddress);
        document.getElementById('walletBalance').textContent = parseFloat(bal).toFixed(4);
        document.getElementById('balanceSymbol').textContent = symbol;
      }

      function updateConnectionBar() {
        const shortAddr = userAddress.substring(0,6) + '...' + userAddress.substring(38);
        document.getElementById('connStatus').textContent = 'Connected';
        document.getElementById('connNetwork').textContent = walletConnector.getNetworkName(walletConnector.chainId || REQUIRED_CHAIN_ID);
        document.getElementById('walletAddress').textContent = shortAddr;
      }

      async function switchToCelo() {
        try {
          await walletConnector.switchNetwork(REQUIRED_CHAIN_ID);
          document.getElementById('switchNetworkBtn').style.display = 'none';
          toast.networkChanged('Celo Mainnet');
          updateConnectionBar();
          updateNetworkIndicator(REQUIRED_CHAIN_ID);
        } catch (e) {
          toast.error('Switch Failed', e.message);
        }
      }

      function copyAddress() {
        navigator.clipboard.writeText(userAddress || '');
        toast.info('Copied', 'Address copied to clipboard', { duration: 1500 });
      }

      function copyContractAddress() {
        navigator.clipboard.writeText(CONTRACT_ADDR || '');
        toast.info('Copied', 'Contract address copied', { duration: 1500 });
      }

      async function loadStats() {
        if (!contract) {
          showStatus('Please connect wallet first', 'error');
          return;
        }

        try {
          const stats = await contract.getStats();
          document.getElementById('statBalance').textContent = 
            parseFloat(ethers.utils.formatEther(stats[0])).toFixed(4);
          document.getElementById('statReceived').textContent = 
            parseFloat(ethers.utils.formatEther(stats[1])).toFixed(4);
          document.getElementById('statWithdrawn').textContent = 
            parseFloat(ethers.utils.formatEther(stats[2])).toFixed(4);
          document.getElementById('statPayments').textContent = stats[3].toString();
          
          document.getElementById('statsContainer').style.display = 'grid';
          showStatus('Stats loaded successfully!', 'success');
        } catch (error) {
          console.error('Stats error:', error);
          showStatus('Failed to load stats: ' + error.message, 'error');
        }
      }

      async function sendPayment() {
        if (!contract) {
          showStatus('Please connect wallet first', 'error');
          return;
        }

        try {
          const amount = document.getElementById('paymentAmount').value;
          const memo = document.getElementById('paymentMemo').value || '';

          if (!amount || parseFloat(amount) <= 0) {
            showStatus('Please enter a valid amount', 'error');
            return;
          }

          // Build transaction preview and estimation
          const baseTx = { to: CONTRACT_ADDR, value: ethers.utils.parseEther(amount) };
          const estimation = await gasEstimator.getCompleteEstimation({ ...baseTx, from: userAddress });
          document.getElementById('gasPanel').style.display = 'block';
          document.getElementById('gasPanel').innerHTML = gasEstimator.generateEstimationUI(estimation.estimations);

          // Click handler to choose speed
          document.querySelectorAll('.gas-option').forEach(el => {
            el.onclick = () => gasEstimator.selectSpeed(el.getAttribute('data-speed'));
          });

          const preview = `Preparing to send <b>${amount} ${tokenManager.getSelectedToken().symbol}</b> to contract with memo: "${memo}"`;
          const txPrev = document.getElementById('txPreview');
          txPrev.style.display = 'block';
          txPrev.innerHTML = preview;

          // Send transaction
          const toastLoading = toast.loading('Sending Transaction', 'Awaiting user confirmation...');
          // Build gas overrides using selected speed
          const overrides = await gasEstimator.buildTransaction({ to: CONTRACT_ADDR, value: ethers.utils.parseEther(amount) });
          const tx = await contract.payWithMemo(memo, overrides);
          toast.dismiss(toastLoading);
          const loadingToastId = toast.transactionSent(tx.hash);

          // Track tx
          txHistory.addTransaction({ hash: tx.hash, from: userAddress, to: CONTRACT_ADDR, value: ethers.utils.parseEther(amount).toString(), memo, gasPrice: overrides.gasPrice.toString() });
          await tx.wait();
          toast.transactionConfirmed(tx.hash, loadingToastId);
          
          await loadStats();
          await renderTxHistory();

        } catch (error) {
          console.error('Payment error:', error);
          showStatus('Payment failed: ' + error.message, 'error');
          toast.transactionFailed(error.message);
        }
      }

      async function withdrawFunds() {
        if (!contract) return;

        try {
          const to = document.getElementById('withdrawTo').value;
          const amount = document.getElementById('withdrawAmount').value;

          if (!to || !amount) {
            showStatus('Please enter recipient and amount', 'error');
            return;
          }

          showStatus('Withdrawing...', 'info');

          const tx = await contract.withdraw(to, ethers.utils.parseEther(amount));
          await tx.wait();

          showStatus('Withdrawal successful!', 'success');
          await loadStats();

        } catch (error) {
          showStatus('Withdrawal failed: ' + error.message, 'error');
        }
      }

      async function withdrawAll() {
        if (!contract) return;

        try {
          if (!confirm('Withdraw all funds to your address?')) return;

          showStatus('Withdrawing all...', 'info');

          const tx = await contract.withdrawAll();
          await tx.wait();

          showStatus('All funds withdrawn successfully!', 'success');
          await loadStats();

        } catch (error) {
          showStatus('Withdrawal failed: ' + error.message, 'error');
        }
      }

      async function pauseContract() {
        if (!contract) return;
        try {
          const tx = await contract.pause();
          await tx.wait();
          showStatus('Contract paused!', 'success');
        } catch (error) {
          showStatus('Failed to pause: ' + error.message, 'error');
        }
      }

      async function unpauseContract() {
        if (!contract) return;
        try {
          const tx = await contract.unpause();
          await tx.wait();
          showStatus('Contract unpaused!', 'success');
        } catch (error) {
          showStatus('Failed to unpause: ' + error.message, 'error');
        }
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.className = type;
        statusDiv.innerHTML = message;
      }

      // Auto-connect if previously connected
      window.addEventListener('load', async () => {
        try {
          if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
              await connect('metamask');
            }
            // Show indicator even if not connected yet
            updateNetworkIndicator(window.ethereum.chainId ? parseInt(window.ethereum.chainId, 16) : null);
            setupChainListeners();
          }
        } catch {}
      });

      function updateNetworkIndicator(chainId) {
        const el = document.getElementById('networkIndicator');
        if (!el) return;
        el.style.display = 'flex';
        const statusText = document.getElementById('networkStatusText');
        const inlineSwitch = document.getElementById('networkSwitchInline');
        if (chainId === REQUIRED_CHAIN_ID) {
          el.classList.remove('network-bad');
          el.classList.add('network-ok');
          statusText.innerHTML = 'âœ… Celo Mainnet (42220)';
          inlineSwitch.style.display = 'none';
        } else {
          el.classList.remove('network-ok');
          el.classList.add('network-bad');
          statusText.innerHTML = chainId ? `âš  Wrong Network (${chainId})` : 'âš  Unknown Network';
          inlineSwitch.style.display = 'inline-block';
        }
      }

      function setupChainListeners() {
        if (typeof window.ethereum === 'undefined') return;
        if (window.ethereum._celoChainListenerAttached) return; // prevent duplicates
        window.ethereum.on('chainChanged', (hexChainId) => {
          const cid = parseInt(hexChainId, 16);
          updateNetworkIndicator(cid);
          if (cid !== REQUIRED_CHAIN_ID) {
            document.getElementById('switchNetworkBtn').style.display = 'inline-block';
            toast.wrongNetwork('Celo Mainnet');
          } else {
            document.getElementById('switchNetworkBtn').style.display = 'none';
            toast.networkChanged('Celo Mainnet');
          }
        });
        window.ethereum._celoChainListenerAttached = true;
      }

      // Render tx history
      async function renderTxHistory() {
        const container = document.getElementById('txHistory');
        const items = txHistory.getRecent(20).map(tx => txHistory.formatTransaction(tx));
        if (items.length === 0) { container.innerHTML = '<em>No transactions yet.</em>'; return; }
        container.innerHTML = items.map(tx => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid #eee;">
            <div>
              <div style="font-weight:600; color:${tx.statusColor}">${tx.statusIcon} ${tx.status.toUpperCase()} Â· ${tx.valueFormatted} CELO</div>
              <div style="font-size:12px; color:#666">${tx.timestampFormatted}</div>
              <a href="${tx.explorerUrl}" target="_blank" rel="noopener noreferrer" style="font-size:12px">View on CeloScan â†—</a>
            </div>
            <button onclick="navigator.clipboard.writeText('${tx.hash}')">Copy Hash</button>
          </div>`).join('');
      }

      function exportHistory() { txHistory.downloadCSV(); }
      function clearHistory() { txHistory.clear(); renderTxHistory(); }
    </script>
  </body>
</html>
